name: CI Dev to Main

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write


jobs:
  minikube:
    name: üèóÔ∏è Deploy & Test core-user-service with postgres service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          KUBECTL_VERSION="v1.30.1"
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: v1.30.1

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0
      - name: Copy Helm chart from private repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/VisioBook-ESP/infra-helm-charts.git tmp-repo
          cp -r tmp-repo/environnement/dev/charts/postgresql-db ./charts/postgresql-db
          cp -r tmp-repo/environnement/dev/charts/core-user-service ./charts/core-user-service
          ls -la ./charts/

      - name: Deploy core-user-service with postgres service on Minikube
        working-directory: ./charts
        run: |
          ls  -la
          pwd
          helm install support-storage ./core-user-service/
          helm install postgresql-db ./postgresql-db/